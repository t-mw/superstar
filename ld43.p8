pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

local template_size = 8
local map_size_templates = 2
local map_size = map_size_templates * template_size
local max_move_timer = 5

local state = {
   camera = { sx = 0, sy = 0 },
   player = { tx = 1, ty = 1, dir = 0, input_dir = 0, move_timer = max_move_timer }
}

function dir_to_dx_dy(dir)
   if dir == 0 then
      return -1, 0
   elseif dir == 1 then
      return 1, 0
   elseif dir == 2 then
      return 0, -1
   elseif dir == 3 then
      return 0, 1
   end
end

function to_1d_idx(x, y, size)
   return (x - 1) * size + y
end

function to_2d_idx(i, size)
  return flr((i - 1) / size) + 1, ((i - 1) % size) + 1
end

function is_valid_idx(x, y, size)
   return x >= 1 and x <= size and y >= 1 and y <= size
end

if true then
   local x, y = to_2d_idx(1, 2)
   assert(x == 1)
   assert(y == 1)
   assert(to_1d_idx(x, y, 2) == 1)

   local x, y = to_2d_idx(4, 2)
   assert(x == 2)
   assert(y == 2)
   assert(to_1d_idx(x, y, 2) == 4)
end

function tile_to_screen(tx, ty)
   return tx * 10, ty * 10
end

function lerp(a, b, t)
   return a + (b - a) * t
end

function is_tile_empty(tx, ty, map)
   if not is_valid_idx(tx, ty, map_size) then
      return false
   end

   local tile = map[to_1d_idx(tx, ty, map_size)]
   return tile == 2 or tile == 3
end

local templates = {}
for tx = 0, 127, template_size do
   for ty = 0, 127, template_size do
      if mget(tx, ty) then

         local template = {}
         add(templates, template)

         for x = 0, template_size - 1 do
            for y = 0, template_size - 1 do
               local idx = to_1d_idx(x + 1, y + 1, template_size)
               template[idx] = mget(tx + x, ty + y)
            end
         end
      end
   end
end

local map = {}
for x = 1, map_size do
   for y = 1, map_size do
      local idx = to_1d_idx(x, y, map_size)
      local tidx = to_1d_idx(
         ((x - 1) % template_size) + 1,
         ((y - 1) % template_size) + 1,
         template_size
      )

      map[idx] = templates[1][tidx]
   end
end

function _update()
   local cam = state.camera
   local player = state.player

   player.move_timer -= 1

   for dir = 0, 3 do
      if btnp(dir) then
         player.input_dir = dir
      end
   end

   function try_move(dir)
      local dx, dy = dir_to_dx_dy(dir)

      local tx = player.tx + dx
      local ty = player.ty + dy

      if player.move_timer <= 0 and is_tile_empty(tx, ty, map) then
         player.tx = tx
         player.ty = ty
         player.dir = dir
         player.move_timer = max_move_timer
         return true
      end

      return false
   end

   if try_move(player.input_dir) or try_move(player.dir) then end

   local padding = 40
   local sx_max, sy_max = tile_to_screen(player.tx + 1, player.ty + 1)
   local sx_min, sy_min = tile_to_screen(player.tx, player.ty)

   local xdiff = max(sx_max - (cam.sx + 128 - padding), 0) + min(sx_min - (cam.sx + padding), 0)
   local ydiff = max(sy_max - (cam.sy + 128 - padding), 0) + min(sy_min - (cam.sy + padding), 0)
   cam.sx += xdiff / 20
   cam.sy += ydiff / 20
end

function _draw()
   cls(0)
   camera(state.camera.sx, state.camera.sy)

   function draw_tile(tx, ty, clr)
      local x0, y0 = tile_to_screen(tx, ty)
      local x1, y1 = tile_to_screen(tx + 1, ty + 1)
      x1 -= 1
      y1 -= 1
      rectfill(x0, y0, x1, y1, clr)
   end

   for x = 1, map_size do
      for y = 1, map_size do
         local idx = to_1d_idx(x, y, map_size)
         local clr = map[idx]
         draw_tile(x, y, clr)
      end
   end

   function get_prev_player_position(player)
      local dx, dy = dir_to_dx_dy(player.dir)
      return player.tx - dx, player.ty - dy
   end

   local player = state.player
   local move_frac = 1 - max(0, player.move_timer / max_move_timer)
   local tx0, ty0 = get_prev_player_position(player)
   local sx = lerp(tx0, player.tx, move_frac)
   local sy = lerp(ty0, player.ty, move_frac)

   draw_tile(sx, sy, 5)
end

__gfx__
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010302020101020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0302010202020202020103020301020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010101020101010101010101020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020102020102020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020103020202030102010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020101010201010102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103010101010101010202020202010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102030101020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
