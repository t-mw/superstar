pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

local template_size = 8
local map_size_templates = 2
local map_size = map_size_templates * template_size

local state = {
 camera = { x = 0, y = 0 }
}

function to_1d_idx(x, y, size)
   return (x - 1) * size + y
end

function to_2d_idx(i, size)
  return flr((i - 1) / size) + 1, ((i - 1) % size) + 1
end

if true then
   local x, y = to_2d_idx(1, 2)
   assert(x == 1)
   assert(y == 1)
   assert(to_1d_idx(x, y, 2) == 1)

   local x, y = to_2d_idx(4, 2)
   assert(x == 2)
   assert(y == 2)
   assert(to_1d_idx(x, y, 2) == 4)
end

local templates = {}
for tx = 0, 127, template_size do
   for ty = 0, 127, template_size do
      if mget(tx, ty) then

         local template = {}
         add(templates, template)

         for x = 0, template_size - 1 do
            for y = 0, template_size - 1 do
               local idx = to_1d_idx(x + 1, y + 1, template_size)
               template[idx] = mget(tx + x, ty + y)
            end
         end
      end
   end
end

local map = {}
for x = 1, map_size do
   for y = 1, map_size do
      local idx = to_1d_idx(x, y, map_size)
      local tidx = to_1d_idx(
         ((x - 1) % template_size) + 1,
         ((y - 1) % template_size) + 1,
         template_size
      )

      map[idx] = templates[1][tidx]
   end
end

function _update()
   local cam = state.camera

   if btn(0) then
      cam.x -= 1
   end
   if btn(1) then
      cam.x += 1
   end
   if btn(2) then
      cam.y -= 1
   end
   if btn(3) then
      cam.y += 1
   end
end

function _draw()
   cls(0)
   camera(state.camera.x, state.camera.y)

   for x = 1, map_size do
      for y = 1, map_size do
         local idx = to_1d_idx(x, y, map_size)
         local clr = map[idx]
         rectfill(x * 10, y * 10, (x + 1) * 10, (y + 1) * 10, clr)
      end
   end
end

__gfx__
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111116666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010302020101020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0302010202020202020103020301020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010101020101010101010101020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020102020102020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020103020202030102010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020101010201010102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103010101010101010202020202010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102030101020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
